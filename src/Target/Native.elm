module Target.Native exposing
    ( CodegenConfig
    , generateCode
    )

{-| Native target code generation.

This module handles generation of C code for native execution
(standard desktop/server environments with stdio support).

-}

import AST.Source as Src
import Codegen.Shared exposing (MainValue(..), escapeC, getModuleName)


{-| Configuration for native code generation.
Provides callbacks to shared code generation functions in Cli.elm.
-}
type alias CodegenConfig =
    { extractMain : Src.Module -> MainValue
    , generateImportCode : List Src.Import -> String
    , generateStandaloneForwardDecl : Src.Located Src.Value -> String
    , generateStandaloneFunction : Src.Located Src.Value -> String
    }


{-| Generate standalone C code for native target (regular computer).
-}
generateCode : CodegenConfig -> Src.Module -> String
generateCode config ast =
    let
        moduleName =
            getModuleName ast

        -- Process imports to generate includes
        importCode =
            config.generateImportCode ast.imports

        -- Separate helper functions from main
        ( helpers, _ ) =
            List.partition
                (\(Src.At _ v) ->
                    let
                        (Src.At _ name) =
                            v.name
                    in
                    name /= "main"
                )
                ast.values

        -- Generate forward declarations for helpers
        forwardDecls =
            List.map config.generateStandaloneForwardDecl helpers

        -- Generate helper function implementations
        helperImpls =
            List.map config.generateStandaloneFunction helpers

        -- Generate main
        mainValue =
            config.extractMain ast

        ( returnType, returnExpr, printFormat ) =
            case mainValue of
                MainString s ->
                    ( "const char *", "\"" ++ escapeC s ++ "\"", "%s" )

                MainInt n ->
                    ( "int", String.fromInt n, "%d" )

                MainExpr cType cExpr ->
                    ( cType, cExpr, if cType == "int" then "%d" else "%s" )

        header =
            [ "/*"
            , " * Generated by tcelm from " ++ moduleName
            , " * Standalone native version"
            , " */"
            , ""
            , "#include <stdio.h>"
            , ""
            ]

        mainImpl =
            [ "static " ++ returnType ++ " elm_main(void) {"
            , "    return " ++ returnExpr ++ ";"
            , "}"
            , ""
            , "int main(void) {"
            , "    printf(\"" ++ printFormat ++ "\\n\", elm_main());"
            , "    return 0;"
            , "}"
            ]
    in
    String.join "\n"
        (header
            ++ [ importCode ]
            ++ [ "/* Forward declarations */" ]
            ++ forwardDecls
            ++ [ "" ]
            ++ [ "/* Helper functions */" ]
            ++ helperImpls
            ++ [ "" ]
            ++ [ "/* Main */" ]
            ++ mainImpl
        )
