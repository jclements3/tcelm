module Target.Native exposing
    ( CodegenConfig
    , generateCode
    )

{-| Native target code generation.

This module handles generation of C code for native execution
(standard desktop/server environments with stdio support).

-}

import AST.Source as Src
import Codegen.Shared exposing (MainValue(..), escapeC, getModuleName)


{-| Configuration for native code generation.
Provides callbacks to shared code generation functions in Cli.elm.
-}
type alias CodegenConfig =
    { extractMain : Src.Module -> MainValue
    , generateImportCode : List Src.Import -> String
    , generateStandaloneForwardDecl : Src.Located Src.Value -> String
    , generateStandaloneFunction : Src.Located Src.Value -> String
    }


{-| Generate standalone C code for native target (regular computer).
-}
generateCode : CodegenConfig -> Src.Module -> String
generateCode config ast =
    let
        moduleName =
            getModuleName ast

        -- Process imports to generate includes
        importCode =
            config.generateImportCode ast.imports

        -- Separate helper functions from main
        ( helpers, _ ) =
            List.partition
                (\(Src.At _ v) ->
                    let
                        (Src.At _ name) =
                            v.name
                    in
                    name /= "main"
                )
                ast.values

        -- Generate forward declarations for helpers
        forwardDecls =
            List.map config.generateStandaloneForwardDecl helpers

        -- Generate helper function implementations
        helperImpls =
            List.map config.generateStandaloneFunction helpers

        -- Generate main
        mainValue =
            config.extractMain ast

        header =
            [ "/*"
            , " * Generated by tcelm from " ++ moduleName
            , " * Standalone native version"
            , " */"
            , ""
            , "#include <stdio.h>"
            , ""
            ]

        mainImpl =
            case mainValue of
                MainString s ->
                    [ "static const char * elm_main(void) {"
                    , "    return \"" ++ escapeC s ++ "\";"
                    , "}"
                    , ""
                    , "int main(void) {"
                    , "    printf(\"%s\\n\", elm_main());"
                    , "    return 0;"
                    , "}"
                    ]

                MainInt n ->
                    [ "static int elm_main(void) {"
                    , "    return " ++ String.fromInt n ++ ";"
                    , "}"
                    , ""
                    , "int main(void) {"
                    , "    printf(\"%d\\n\", elm_main());"
                    , "    return 0;"
                    , "}"
                    ]

                MainExpr cType cExpr ->
                    let
                        printFormat = if cType == "int" then "%d" else "%s"
                    in
                    [ "static " ++ cType ++ " elm_main(void) {"
                    , "    return " ++ cExpr ++ ";"
                    , "}"
                    , ""
                    , "int main(void) {"
                    , "    printf(\"" ++ printFormat ++ "\\n\", elm_main());"
                    , "    return 0;"
                    , "}"
                    ]

                MainNone ->
                    [ "/* Library module - no main() */" ]
    in
    String.join "\n"
        (header
            ++ [ importCode ]
            ++ [ "/* Forward declarations */" ]
            ++ forwardDecls
            ++ [ "" ]
            ++ [ "/* Helper functions */" ]
            ++ helperImpls
            ++ [ "" ]
            ++ [ "/* Main */" ]
            ++ mainImpl
        )
