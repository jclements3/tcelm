#!/bin/bash
#
# tcelm-cc - TCC cross-compiler for NUC/RTEMS
#
# Usage: tcelm-cc [options] source.c -o output
#
# This wrapper sets up TCC with the correct include paths and libraries
# for compiling tcelm programs targeting the Intel NUC with RTEMS.
#

set -e

TOOLCHAIN_DIR="$(cd "$(dirname "$0")/.." && pwd)"
TCC="${TOOLCHAIN_DIR}/../tcc/tcc"

# Default to 32-bit (NUC can run both, but 32-bit is simpler)
ARCH="-m32"
TARGET="bare"  # bare, qemu, or rtems

# Parse our options
while [[ $# -gt 0 ]]; do
    case $1 in
        --target=*)
            TARGET="${1#*=}"
            shift
            ;;
        --64)
            ARCH="-m64"
            shift
            ;;
        --32)
            ARCH="-m32"
            shift
            ;;
        --help|-h)
            cat <<EOF
tcelm-cc - TCC cross-compiler for NUC/RTEMS

Usage: tcelm-cc [options] source.c -o output

Options:
  --target=TARGET   Target platform (bare, qemu, rtems)
                    bare  - Bare metal, no OS (default)
                    qemu  - Bare metal with QEMU multiboot
                    rtems - Link with RTEMS (requires RTEMS toolchain)
  --32              Generate 32-bit code (default)
  --64              Generate 64-bit code
  -c                Compile only, don't link
  -o FILE           Output file
  -I DIR            Add include directory
  -D NAME[=VALUE]   Define macro
  --help, -h        Show this help

Examples:
  tcelm-cc hello.c -o hello.elf
  tcelm-cc --target=qemu test.c -o test.elf
  tcelm-cc -c mylib.c -o mylib.o

Environment:
  TCELM_TOOLCHAIN   Path to toolchain directory
EOF
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

# Set up include paths
INCLUDES=(
    "-I${TOOLCHAIN_DIR}/include"
    "-I${TOOLCHAIN_DIR}/../runtime"
)

# Set up library paths
LIBS=(
    "-L${TOOLCHAIN_DIR}/lib"
)

# Base compiler flags
CFLAGS=(
    $ARCH
    "-nostdlib"
    "-nostdinc"
    "-D__rtems__"
    "-DTCELM_TARGET_NUC"
)

# Target-specific flags
case $TARGET in
    bare)
        CFLAGS+=("-DTCELM_BARE_METAL")
        ;;
    qemu)
        CFLAGS+=("-DTCELM_QEMU")
        ;;
    rtems)
        CFLAGS+=("-DTCELM_RTEMS_FULL")
        ;;
esac

# Run TCC with our configuration
exec "$TCC" "${CFLAGS[@]}" "${INCLUDES[@]}" "${LIBS[@]}" "$@"
